<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Card Game Battle GUI - SC & Break Fix</title>
    <style>
        /* --- ÂÖ®‰Ωì„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà --- */
        body {
            background-color: #202020;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- ÁîªÈù¢Âàá„ÇäÊõø„ÅàÁî® --- */
        .screen { width: 100%; height: 100%; display: none; }
        .active-screen { display: flex; }

        /* --- „Çø„Ç§„Éà„É´ÁîªÈù¢ --- */
        #title-screen {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, #2b2b2b 0%, #1a1a1a 100%);
            z-index: 200;
        }
        h1 { font-size: 48px; margin-bottom: 10px; color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        p.subtitle { color: #aaa; margin-bottom: 40px; }
        #char-list { display: flex; gap: 30px; }
        .char-select-card {
            width: 220px;
            background: #333;
            border: 2px solid #555;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .char-select-card:hover { transform: translateY(-10px); border-color: #00bcd4; background: #3a3a3a; }
        .char-icon { font-size: 50px; margin-bottom: 10px; }
        .char-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .char-stats { font-size: 14px; color: #ccc; text-align: left; margin-top: 10px; line-height: 1.6; }

        /* --- „Ç≤„Éº„É†ÁîªÈù¢ --- */
        #game-area {
            flex: 7;
            display: flex; flex-direction: column;
            border-right: 2px solid #444;
            background: radial-gradient(circle at center, #2a2a2a, #1a1a1a);
            position: relative;
        }
        #log-area {
            flex: 3; background: #111; padding: 10px; overflow-y: auto;
            font-family: 'Consolas', monospace; font-size: 14px; border-left: 1px solid #333;
        }
        .player-zone {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 10px;
        }
        #battle-zone {
            flex: 1.5; border-top: 1px solid #444; border-bottom: 1px solid #444;
            display: flex; justify-content: center; align-items: center; gap: 40px;
            background-color: rgba(0,0,0,0.2);
        }
        .status-box {
            width: 80%; background: rgba(0,0,0,0.5); padding: 10px;
            border-radius: 8px; margin-bottom: 10px; text-align: center;
        }
        .hp-bar-bg {
            width: 100%; height: 15px; background: #555;
            border-radius: 10px; margin-top: 5px; overflow: hidden;
        }
        .hp-bar-fill {
            height: 100%; background: linear-gradient(90deg, #4caf50, #81c784);
            width: 100%; transition: width 0.5s ease;
        }
        .status-icons { margin-top: 5px; font-size: 14px; color: #ffcc00; min-height: 20px;}

        /* „Ç´„Éº„Éâ */
        .hand-container { display: flex; gap: 15px; justify-content: center; perspective: 1000px; }
        .card {
            width: 100px; height: 140px; background: #fff; color: #000;
            border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between;
            padding: 10px; box-sizing: border-box; position: relative;
            cursor: pointer; transition: transform 0.2s; user-select: none;
        }
        .card:hover { transform: translateY(-15px) scale(1.05); z-index: 10; }
        .card.disabled { filter: grayscale(100%) brightness(0.5); cursor: not-allowed; pointer-events: none; }
        
        .card-blank { border: 2px solid #ccc; background: linear-gradient(135deg, #fff, #f0f0f0); }
        .card-skill { border: 2px solid #ffd700; background: linear-gradient(135deg, #fff, #fffde7); }
        .card-joker { border: 2px solid #9c27b0; background: linear-gradient(135deg, #f3e5f5, #e1bee7); color: #4a148c; }
        .card-break { border: 2px solid #00bcd4; background: linear-gradient(135deg, #e0f7fa, #b2ebf2); color: #006064; }
        
        .card-top { font-size: 18px; font-weight: bold; }
        .card-center { font-size: 32px; text-align: center; margin-top: 10px; }
        .card-name { font-size: 10px; text-align: center; color: #555; font-weight: bold; }

        /* „É¢„Éº„ÉÄ„É´ */
        #modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content { background: #333; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #777; }
        .btn { background: #0e639c; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 4px; font-size: 16px; }
        .btn:hover { background: #1177bb; }
        .btn-atk { background: #d32f2f; }
        .btn-def { background: #1976d2; }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .c-p1 { color: #64b5f6; }
        .c-p2 { color: #e57373; }
        .c-sys { color: #81c784; }
        .c-dmg { color: #ffb74d; font-weight: bold; }
    </style>
</head>
<body>

    <div id="title-screen" class="screen active-screen">
        <h1>CARD BATTLE</h1>
        <p class="subtitle">„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Éê„Éà„É´ÈñãÂßã</p>
        <div id="char-list"></div>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-area">
            <div class="player-zone">
                <div class="status-box">
                    <div id="p2-name">Player 2</div>
                    <div class="hp-bar-bg"><div id="p2-hp-bar" class="hp-bar-fill"></div></div>
                    <div id="p2-hp-text">HP: 36/36</div>
                    <div id="p2-status" class="status-icons"></div>
                    <div>JKP: <span id="p2-jkp">0</span> / SC: <span id="p2-sc">0</span></div>
                </div>
                <div class="hand-container" id="p2-hand-view" style="opacity: 0.7; transform: scale(0.8);"></div>
            </div>

            <div id="battle-zone">
                <div style="position:absolute; color:#aaa; top: 10px;">BATTLE FIELD</div>
                <div id="p1-play-card"></div>
                <div style="font-size:30px; font-weight:bold;">VS</div>
                <div id="p2-play-card"></div>
            </div>

            <div class="player-zone">
                <div class="hand-container" id="p1-hand-view"></div>
                <div class="status-box" style="margin-top: 20px;">
                    <div id="p1-name">Player 1</div>
                    <div class="hp-bar-bg"><div id="p1-hp-bar" class="hp-bar-fill"></div></div>
                    <div id="p1-hp-text">HP: 20/20</div>
                    <div id="p1-status" class="status-icons"></div>
                    <div>JKP: <span id="p1-jkp">0</span> / SC: <span id="p1-sc">0</span></div>
                </div>
            </div>

            <div id="modal-overlay">
                <div class="modal-content">
                    <h3 id="modal-title">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    <div id="modal-buttons"></div>
                </div>
            </div>
        </div>

        <div id="log-area">
            <div style="text-align:center; color:#888; border-bottom:1px solid #555; margin-bottom:10px;">BATTLE LOG</div>
            <div id="logs"></div>
        </div>
    </div>

<script>
// ==========================================
// ÂÆöÊï∞ & „Ç≠„É£„É©„ÇØ„Çø„Éº„Éá„Éº„Çø
// ==========================================
const CARD_TYPE = { BLANK: 'blank', SKILL: 'skill', JOKER: 'joker', SPELL_BREAK: 'break' };
const CARD_MODE = { ATTACK: 'attack', DEFENSE: 'defense' };

const CHARACTERS = {
    berserker: {
        id: 'berserker', name: "„Éê„Éº„Çµ„Éº„Ç´„Éº", icon: "üëπ",
        maxHp: 20, jkpCost: 8, scMax: 0, // ‚òÖSCË®≠ÂÆö
        description: "ÊîªÊíÉÁâπÂåñÂûã„ÄÇ<br>HP„ÅØ‰Ωé„ÅÑ„Åå„ÄÅÈÄöÂ∏∏ÊîªÊíÉ„ÅÆÂ®ÅÂäõ„ÅåÈ´ò„Åè„ÄÅ„Ç∏„Éß„Éº„Ç´„Éº„ÅßÂº∑Âäõ„Å™Á∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ",
        passive: (p, type, data) => {
            if (type === 'attack_hit' && data.card.type === CARD_TYPE.BLANK) {
                ui.print(`üî• [„Éë„ÉÉ„Ç∑„Éñ] JKP+1`);
                p.jkp += 1;
            }
        },
        skillEffect: (me, op, val) => {
            ui.print(`‚öîÔ∏è [„Çπ„Ç≠„É´] ÂèåÊíÉ!`, 'c-p1');
            op.receiveDamage(2); op.receiveDamage(2);
            op.addStatus(new StatusEffect('Ë≤†ÂÇ∑', 'debuff', 1, 1));
        },
        jokerEffect: (me, op) => {
            ui.print(`üëπ [JOKER] ÊÄ™Âäõ‰π±Á•û!`, 'c-p1');
            op.addStatus(new StatusEffect('Ë≤†ÂÇ∑', 'debuff', 1, 20));
            op.receiveDamage(2);
        }
    },
    venom: {
        id: 'venom', name: "„É¥„Çß„Éé„É†", icon: "üß™",
        maxHp: 36, jkpCost: 0, scMax: 0, // ‚òÖSCË®≠ÂÆö
        description: "ËÄê‰πÖÔºÜÊØíÂûã„ÄÇ<br>È´ò„ÅÑHP„ÇíÊåÅ„Å°„ÄÅÁõ∏Êâã„ÇíÂæê„ÄÖ„Å´Ââä„Çã„ÄÇ„Ç∏„Éß„Éº„Ç´„Éº„ÅßÁõ∏Êâã„ÅÆÊØí„ÇíÂê∏Âèé„ÅóÂõûÂæ©„Åô„Çã„ÄÇ",
        passive: (p, type, data) => {
            if (type === 'attack_hit' && data.card.type === CARD_TYPE.BLANK) {
                ui.print(`üß™ [„Éë„ÉÉ„Ç∑„Éñ] Ê≠ªÊØí+2`);
                data.opponent.addStatus(new StatusEffect('Ê≠ªÊØí', 'debuff', 2));
            }
        },
        skillEffect: (me, op, val) => {
            ui.print(`üå´Ô∏è [„Çπ„Ç≠„É´] „Éù„Ç§„Ç∫„É≥„Éü„Çπ„Éà!`, 'c-p2');
            op.addStatus(new StatusEffect('Ê≠ªÊØí', 'debuff', 5));
        },
        jokerEffect: (me, op) => {
            ui.print(`üíâ [JOKER] „Ç™„Éº„Éê„Éº„Éâ„Éº„Ç∫!`, 'c-p2');
            let idx = op.statusList.findIndex(s => s.name === 'Ê≠ªÊØí');
            if (idx !== -1) {
                let poison = op.statusList[idx];
                let dmg = Math.floor(poison.val1 / 2);
                let heal = Math.floor(dmg / 2);
                ui.print(`ÊØíÂê∏Âèé: ${dmg}„ÉÄ„É°, ${heal}ÂõûÂæ©`, 'c-dmg');
                op.receiveDamage(dmg);
                me.hp += heal;
                op.statusList.splice(idx, 1);
            }
        }
    }
};

// ==========================================
// „ÇØ„É©„ÇπÂÆöÁæ©
// ==========================================
class Card {
    constructor(type) {
        this.type = type; this.value = 0; this.mode = CARD_MODE.ATTACK; this.initValue();
    }
    initValue() {
        if (this.type === CARD_TYPE.BLANK || this.type === CARD_TYPE.SKILL) this.value = Math.floor(Math.random() * 13) + 1;
        else if (this.type === CARD_TYPE.JOKER) this.value = 14;
        else if (this.type === CARD_TYPE.SPELL_BREAK) this.value = 0;
    }
}

class StatusEffect {
    constructor(name, type, value1, value2 = null) {
        this.name = name; this.type = type; this.val1 = value1; this.val2 = value2;
    }
    // „ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„ÇãÁõ¥Ââç„Å´Âëº„Å∞„Çå„Çã
    onTakeDamage(owner, damageAmount) {
        // ‚òÖ‰øÆÊ≠£ÁÇπ: „Çπ„Éö„É´„Éñ„É¨„Ç§„ÇØ„ÅÆ„Éö„Éä„É´„ÉÜ„Ç£Âá¶ÁêÜ
        if (this.name === '„Éñ„É¨„Ç§„ÇØÂèçÂãï') {
            ui.print(`‚ö° [„Éñ„É¨„Ç§„ÇØÂèçÂãï] Ë¢´„ÉÄ„É°„Éº„Ç∏+1`, 'c-dmg');
            return damageAmount + 1; // „ÉÄ„É°„Éº„Ç∏„Çí1Â¢ó„ÇÑ„Åô
        }
        
        if (this.name === 'Ë≤†ÂÇ∑' && this.val2 > 0) {
            ui.print(`ü©∏ [Ë≤†ÂÇ∑] ËøΩÂä†„ÉÄ„É°„Éº„Ç∏ ${this.val1}!`, 'c-dmg');
            owner.hp -= this.val1; 
            this.val2 -= 1;
        }
        return damageAmount;
    }
    onTurnEnd(owner) {
        if (this.name === 'Ê≠ªÊØí') {
            const dmg = 2; ui.print(`‚ò†Ô∏è [Ê≠ªÊØí] ${owner.name}„Å´${dmg}„ÉÄ„É°„Éº„Ç∏`, 'c-dmg');
            owner.receiveDamage(dmg); this.val1 -= 1;
        }
    }
    isExpired() {
        if (this.name === 'Ê≠ªÊØí') return this.val1 <= 0;
        if (this.name === 'Ë≤†ÂÇ∑') return this.val2 <= 0;
        if (this.name === '„Éñ„É¨„Ç§„ÇØÂèçÂãï') return true; // 1„Çø„Éº„É≥„ÅßÊ∂àÊªÖ
        return false;
    }
}

class Player {
    constructor(charKey) {
        this.charData = CHARACTERS[charKey];
        this.name = this.charData.name;
        this.hp = this.charData.maxHp;
        this.jkp = 0;
        this.sc = 0; // ‚òÖSCÂàùÊúüÂåñ
        this.hand = [];
        this.statusList = [];
    }
    drawHand() {
        this.hand = [];
        this.hand.push(new Card(CARD_TYPE.BLANK));
        this.hand.push(new Card(CARD_TYPE.BLANK));
        this.hand.push(new Card(CARD_TYPE.SKILL));
        this.hand.push(new Card(CARD_TYPE.JOKER));
        this.hand.push(new Card(CARD_TYPE.SPELL_BREAK));
    }
    addStatus(ef) {
        let exist = this.statusList.find(e => e.name === ef.name);
        if (exist) {
            if (exist.name === 'Ê≠ªÊØí') exist.val1 += ef.val1;
            else if (exist.name === 'Ë≤†ÂÇ∑') { exist.val1 += ef.val1; exist.val2 += ef.val2; }
        } else this.statusList.push(ef);
    }
    receiveDamage(amount) {
        // „Éá„Éê„Éï„Å™„Å©„Å´„Çà„Çã„ÉÄ„É°„Éº„Ç∏Ë£úÊ≠£Ë®àÁÆó
        let finalAmount = amount;
        
        // onTakeDamage„ÅØ„ÄåË£úÊ≠£Âæå„ÅÆ„ÉÄ„É°„Éº„Ç∏„Äç„ÇíËøî„Åô„Çà„ÅÜ„Å´Â§âÊõ¥
        // ÈÖçÂàó„Ç≥„Éî„Éº„Åó„Å¶Âõû„Åô(Âá¶ÁêÜ‰∏≠„Å´Ê∂à„Åà„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ)
        [...this.statusList].forEach(s => {
            finalAmount = s.onTakeDamage(this, finalAmount);
        });

        this.statusList = this.statusList.filter(s => !s.isExpired());

        if(finalAmount < 0) finalAmount = 0;
        this.hp -= finalAmount;
        if (this.hp < 0) this.hp = 0;
    }
}

class Game {
    constructor(p1Key, p2Key) {
        this.p1 = new Player(p1Key);
        this.p2 = new Player(p2Key);
        this.turn = 1;
    }

    // „Ç´„Éº„Éâ„Åå‰ΩøÁî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    isCardPlayable(player, index) {
        const card = player.hand[index];
        // JKP„ÉÅ„Çß„ÉÉ„ÇØ
        if (card.type === CARD_TYPE.JOKER && player.jkp < player.charData.jkpCost) return false;
        // ‚òÖSC„ÉÅ„Çß„ÉÉ„ÇØ
        if (card.type === CARD_TYPE.SKILL && player.sc > 0) return false;
        
        return true;
    }

    async resolveBattle(p1CardIndex, p2CardIndex) {
        const c1 = this.p1.hand[p1CardIndex];
        const c2 = this.p2.hand[p2CardIndex];
        
        ui.showBattleCards(c1, c2);
        ui.print(`‚öîÔ∏è „Éê„Éà„É´Âà§ÂÆö...`);
        await ui.wait(800);

        let winner = null;
        // „Éñ„É¨„Ç§„ÇØÂ§±ÊïóÂà§ÂÆöÁî®
        let p1BreakFail = false; 
        let p2BreakFail = false;

        // --- ÂãùÊïóÂà§ÂÆö ---
        // 1. „Éñ„É¨„Ç§„ÇØ vs „Ç∏„Éß„Éº„Ç´„Éº
        if (c1.type === CARD_TYPE.SPELL_BREAK && c2.type === CARD_TYPE.JOKER) winner = this.p1;
        else if (c2.type === CARD_TYPE.SPELL_BREAK && c1.type === CARD_TYPE.JOKER) winner = this.p2;
        
        // 2. „Éñ„É¨„Ç§„ÇØ vs „Åù„ÅÆ‰ªñ („Éñ„É¨„Ç§„ÇØÂÅ¥„ÅÆË≤†„Åë + „Éö„Éä„É´„ÉÜ„Ç£„Éï„É©„Ç∞)
        else if (c1.type === CARD_TYPE.SPELL_BREAK) { winner = this.p2; p1BreakFail = true; }
        else if (c2.type === CARD_TYPE.SPELL_BREAK) { winner = this.p1; p2BreakFail = true; }
        
        // 3. Êï∞ÂÄ§ÂãùË≤†
        else {
            if (c1.value > c2.value) winner = this.p1;
            else if (c2.value > c1.value) winner = this.p2;
            else {
                // ÂêåÂÄ§
                const p1Def = (c1.mode === CARD_MODE.DEFENSE);
                const p2Def = (c2.mode === CARD_MODE.DEFENSE);
                if (p1Def && !p2Def) winner = this.p1;
                else if (!p1Def && p2Def) winner = this.p2;
            }
        }

        // --- ÁµêÊûúÈÅ©Áî® ---
        
        // ‚òÖ‰øÆÊ≠£ÁÇπ: „Éñ„É¨„Ç§„ÇØÂ§±Êïó(ÂèçÂãï)„ÅÆÈÅ©Áî®
        // ÂãùÊïó„Å´Èñ¢„Çè„Çâ„Åö„ÄÅ„Ç∏„Éß„Éº„Ç´„Éº‰ª•Â§ñ„Å´„Éñ„É¨„Ç§„ÇØ„Çí‰Ωø„Å£„ÅüÂ†¥Âêà„ÅØÂèçÂãï„Éá„Éê„Éï„Çí‰ªò‰∏é
        if (p1BreakFail) this.p1.addStatus(new StatusEffect('„Éñ„É¨„Ç§„ÇØÂèçÂãï', 'debuff', 1));
        if (p2BreakFail) this.p2.addStatus(new StatusEffect('„Éñ„É¨„Ç§„ÇØÂèçÂãï', 'debuff', 1));

        if (winner) {
            const loser = (winner === this.p1) ? this.p2 : this.p1;
            const winCard = (winner === this.p1) ? c1 : c2;
            
            ui.print(`üèÖ ÂãùËÄÖ: ${winner.name}`, 'c-sys');
            
            // ‚òÖSC„Çª„ÉÉ„Éà („Çπ„Ç≠„É´‰ΩøÁî®ÊôÇ)
            if (winCard.type === CARD_TYPE.SKILL) {
                winner.sc = winner.charData.scMax;
            }
            
            this.applyCardEffect(winner, loser, winCard);
        } else {
            ui.print("Draw (Âºï„ÅçÂàÜ„Åë)", 'c-sys');
        }
    }

    applyCardEffect(winner, loser, card) {
        // „Éë„ÉÉ„Ç∑„Éñ
        if (card.type === CARD_TYPE.BLANK && card.mode === CARD_MODE.ATTACK) {
             if (winner.charData.passive) winner.charData.passive(winner, 'attack_hit', { opponent: loser, card: card });
        }
        
        switch (card.type) {
            case CARD_TYPE.BLANK:
                if (card.mode === CARD_MODE.ATTACK) { 
                    ui.print(`üëä ÈÄöÂ∏∏ÊîªÊíÉ (Â®ÅÂäõ:2)`, 'c-dmg'); 
                    loser.receiveDamage(2); 
                }
                else ui.print(`üõ°Ô∏è Èò≤Âæ°ÊàêÂäü`);
                break;
            case CARD_TYPE.SKILL: 
                winner.charData.skillEffect(winner, loser, card.value); 
                break;
            case CARD_TYPE.JOKER: 
                winner.jkp -= winner.charData.jkpCost; 
                winner.charData.jokerEffect(winner, loser); 
                break;
            case CARD_TYPE.SPELL_BREAK: 
                ui.print(`‚ú® „Çπ„Éö„É´„Éñ„É¨„Ç§„ÇØÊàêÂäü`); 
                break;
        }
    }
}

// ==========================================
// GUIÂà∂Âæ°
// ==========================================
const ui = {
    logs: document.getElementById('logs'),
    showGameScreen: () => { document.getElementById('title-screen').style.display = 'none'; document.getElementById('game-screen').style.display = 'flex'; },
    print: (text, type = '') => {
        const div = document.createElement('div'); div.textContent = text; div.className = 'log-entry ' + type;
        ui.logs.appendChild(div); ui.logs.scrollTop = ui.logs.scrollHeight;
    },
    updateStatus: (p1, p2) => {
        const setText = (id, txt) => document.getElementById(id).textContent = txt;
        const setWidth = (id, percent) => document.getElementById(id).style.width = percent + '%';
        const getStatusTxt = (list) => list.map(s => {
            if(s.name === '„Éñ„É¨„Ç§„ÇØÂèçÂãï') return `‚ö°ÂèçÂãï`;
            return s.name === 'Ë≤†ÂÇ∑' ? `ü©∏Ë≤†ÂÇ∑(Â®Å${s.val1}/ÊÆã${s.val2})` : `‚ò†Ô∏èÊ≠ªÊØí(${s.val1})`;
        }).join(' ');

        setText('p1-name', p1.name);
        setText('p1-hp-text', `${p1.hp} / ${p1.charData.maxHp}`);
        setWidth('p1-hp-bar', (p1.hp / p1.charData.maxHp) * 100);
        setText('p1-jkp', p1.jkp);
        setText('p1-sc', p1.sc); // ‚òÖSCË°®Á§∫
        setText('p1-status', getStatusTxt(p1.statusList));

        setText('p2-name', p2.name);
        setText('p2-hp-text', `${p2.hp} / ${p2.charData.maxHp}`);
        setWidth('p2-hp-bar', (p2.hp / p2.charData.maxHp) * 100);
        setText('p2-jkp', p2.jkp);
        setText('p2-sc', p2.sc); // ‚òÖSCË°®Á§∫
        setText('p2-status', getStatusTxt(p2.statusList));
    },
    createCardElement: (card, isHidden = false, onClick = null) => {
        const div = document.createElement('div'); div.className = `card card-${card.type}`;
        if (isHidden) { div.style.background = '#333'; div.style.border = '2px solid #555'; return div; }
        let icon='',label='',modeMark='';
        if(card.type==='blank'){icon='‚öîÔ∏è';label='ÈÄöÂ∏∏';}
        if(card.type==='skill'){icon='‚ö°';label='„Çπ„Ç≠„É´';}
        if(card.type==='joker'){icon='üÉè';label='JOKER';}
        if(card.type==='break'){icon='üõë';label='BREAK';}
        if(card.mode==='defense')modeMark='üõ°Ô∏è';
        div.innerHTML=`<div class="card-top">${card.value===0?'‚àû':card.value}</div><div class="card-center">${icon}${modeMark}</div><div class="card-name">${label}</div>`;
        if(onClick) div.onclick = onClick;
        return div;
    },
    renderHand: (player, isPlayerControlled, callback) => {
        const container = isPlayerControlled ? document.getElementById('p1-hand-view') : document.getElementById('p2-hand-view');
        container.innerHTML = '';
        player.hand.forEach((card, index) => {
            // ‚òÖ‰ΩøÁî®ÂèØËÉΩ„ÉÅ„Çß„ÉÉ„ÇØ
            let isPlayable = true;
            if(!isPlayerControlled) isPlayable = true; // CPUÁî®
            else {
                // JKP‰∏çË∂≥
                if(card.type === CARD_TYPE.JOKER && player.jkp < player.charData.jkpCost) isPlayable = false;
                // SC‰∏≠
                if(card.type === CARD_TYPE.SKILL && player.sc > 0) isPlayable = false;
            }

            const cardEl = ui.createCardElement(card, !isPlayerControlled, () => {
                if (isPlayerControlled && isPlayable && callback) callback(index);
            });
            if (isPlayerControlled && !isPlayable) cardEl.classList.add('disabled');
            container.appendChild(cardEl);
        });
    },
    clearBattleField: () => { document.getElementById('p1-play-card').innerHTML = ''; document.getElementById('p2-play-card').innerHTML = ''; },
    showBattleCards: (c1, c2) => {
        const b1 = document.getElementById('p1-play-card'); const b2 = document.getElementById('p2-play-card');
        b1.innerHTML = ''; b2.innerHTML = ''; b1.appendChild(ui.createCardElement(c1)); b2.appendChild(ui.createCardElement(c2));
    },
    showModal: (title, buttons) => {
        return new Promise(resolve => {
            document.getElementById('modal-title').textContent = title;
            const btnArea = document.getElementById('modal-buttons');
            btnArea.innerHTML = '';
            document.getElementById('modal-overlay').style.display = 'flex';
            buttons.forEach(btn => {
                const b = document.createElement('button'); b.textContent = btn.label; b.className = `btn ${btn.class||''}`;
                b.onclick = () => { document.getElementById('modal-overlay').style.display = 'none'; resolve(btn.value); };
                btnArea.appendChild(b);
            });
        });
    },
    wait: (ms) => new Promise(r => setTimeout(r, ms))
};

// ==========================================
// „É°„Ç§„É≥Âá¶ÁêÜ
// ==========================================
function initCharSelect() {
    const list = document.getElementById('char-list');
    for (const key in CHARACTERS) {
        const c = CHARACTERS[key];
        const card = document.createElement('div'); card.className = 'char-select-card';
        card.innerHTML = `<div class="char-icon">${c.icon}</div><div class="char-name">${c.name}</div><div class="char-stats"><span class="stat-label">HP:</span> ${c.maxHp} <br><span class="stat-label">JKP:</span> ${c.jkpCost} / <span class="stat-label">SC:</span> ${c.scMax}<br>${c.description}</div><div style="margin-top:10px; font-weight:bold; color:#0e639c;">CLICK TO START</div>`;
        card.onclick = () => startGame(key);
        list.appendChild(card);
    }
}

async function startGame(playerCharKey) {
    const allKeys = Object.keys(CHARACTERS);
    const opponentKey = allKeys.find(k => k !== playerCharKey) || 'berserker';
    ui.showGameScreen();
    ui.print("=== BATTLE START ===", 'c-sys');
    
    const game = new Game(playerCharKey, opponentKey);

    while (game.p1.hp > 0 && game.p2.hp > 0) {
        game.turn++;
        game.p1.drawHand(); game.p2.drawHand();
        ui.updateStatus(game.p1, game.p2);
        ui.clearBattleField();
        ui.print(`--- TURN ${game.turn} ---`, 'c-sys');

        ui.renderHand(game.p2, false);
        const p2Index = await autoSelect(game.p2, game);
        const p1Index = await selectCardGUI(game.p1, game);
        
        await game.resolveBattle(p1Index, p2Index);
        ui.updateStatus(game.p1, game.p2);

        if (game.p1.hp <= 0 || game.p2.hp <= 0) break;

        // „Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜ (SCÊ∏õÂ∞ë & Áä∂ÊÖãÁï∞Â∏∏)
        game.p1.jkp++; game.p2.jkp++;
        
        // ‚òÖSCÊ∏õÂ∞ë
        if(game.p1.sc > 0) game.p1.sc--;
        if(game.p2.sc > 0) game.p2.sc--;

        [game.p1, game.p2].forEach(p => {
            p.statusList.forEach(s => s.onTurnEnd(p));
            p.statusList = p.statusList.filter(s => !s.isExpired());
        });
        ui.updateStatus(game.p1, game.p2);
        
        await ui.showModal("„Çø„Éº„É≥ÁµÇ‰∫Ü", [{ label: "Ê¨°„Å∏", value: "next" }]);
    }

    ui.print("=== GAME SET ===", 'c-sys');
    const winnerName = game.p1.hp > 0 ? game.p1.name : game.p2.name;
    await ui.showModal(`ÂãùËÄÖ: ${winnerName}`, [{ label: "„Çø„Ç§„Éà„É´„Å∏Êàª„Çã", value: "retry" }]);
    location.reload();
}

function selectCardGUI(player, game) {
    return new Promise(resolve => {
        ui.print(`„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥: „Ç´„Éº„Éâ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ`, 'c-sys');
        ui.renderHand(player, true, async (index) => {
            const card = player.hand[index];
            if (card.type === CARD_TYPE.BLANK) {
                const mode = await ui.showModal("„É¢„Éº„ÉâÈÅ∏Êäû", [{ label: "‚öîÔ∏è ÊîªÊíÉ", value: "attack", class: "btn-atk" }, { label: "üõ°Ô∏è Èò≤Âæ°", value: "defense", class: "btn-def" }]);
                card.mode = (mode === 'defense') ? CARD_MODE.DEFENSE : CARD_MODE.ATTACK;
            }
            document.getElementById('p1-hand-view').innerHTML = ''; 
            resolve(index);
        });
    });
}

async function autoSelect(player, game) {
    let validIndexes = [];
    player.hand.forEach((c, i) => { if (game.isCardPlayable(player, i)) validIndexes.push(i); });
    const choice = validIndexes[Math.floor(Math.random() * validIndexes.length)];
    if (player.hand[choice].type === CARD_TYPE.BLANK) {
        if (Math.random() > 0.5) player.hand[choice].mode = CARD_MODE.DEFENSE;
    }
    return choice;
}

initCharSelect();

</script>
</body>
</html>
